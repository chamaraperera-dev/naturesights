"use strict";var Ht=Object.create;var G=Object.defineProperty;var Ft=Object.getOwnPropertyDescriptor;var Wt=Object.getOwnPropertyNames,pe=Object.getOwnPropertySymbols,Lt=Object.getPrototypeOf,ge=Object.prototype.hasOwnProperty,Jt=Object.prototype.propertyIsEnumerable;var me=(e,t,r)=>t in e?G(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,H=(e,t)=>{for(var r in t||={})ge.call(t,r)&&me(e,r,t[r]);if(pe)for(var r of pe(t))Jt.call(t,r)&&me(e,r,t[r]);return e};var Vt=(e,t,r,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of Wt(t))!ge.call(e,s)&&s!==r&&G(e,s,{get:()=>t[s],enumerable:!(o=Ft(t,s))||o.enumerable});return e};var u=(e,t,r)=>(r=e!=null?Ht(Lt(e)):{},Vt(t||!e||!e.__esModule?G(r,"default",{value:e,enumerable:!0}):r,e));var a=(e,t,r)=>new Promise((o,s)=>{var n=f=>{try{g(r.next(f))}catch(v){s(v)}},l=f=>{try{g(r.throw(f))}catch(v){s(v)}},g=f=>f.done?o(f.value):Promise.resolve(f.value).then(n,l);g((r=r.apply(e,t)).next())});var de=u(require("mongoose")),Ut=u(require("dotenv"));var le=u(require("path")),j=u(require("express")),At=u(require("morgan"));var Q=class extends Error{constructor(r,o){super(r);this.statusCode=o,this.status=`${o}`.startsWith("4")?"fail":"error",this.isOperational=!0,Error.captureStackTrace(this,this.constructor)}},i=Q;var zt=e=>{let t=`Invalid ${e.path}:${e.value}`;return new i(t,400)},Yt=e=>{let r=`Duplicate field value: '${e.keyValue.name}' Please use another value`;return new i(r,400)},Gt=e=>{let r=`Invalid input data. ${Object.values(e.errors).map(o=>o.message).join(". ")}`;return new i(r,400)},Qt=()=>new i("Invalid token. Please log in again",401),Kt=()=>new i("Your token has expired! Please log in again",401),Xt=(e,t,r)=>t.originalUrl.startsWith("/api")?r.status(e.statusCode).json({status:e.status,error:e,message:e.message,stack:e.stack}):(console.log("ERROR",e),r.status(e.statusCode).render("error",{title:"Something went wrong!",msg:e.message})),Zt=e=>e.status(500).json({status:"error",message:"Something went wrong"}),fe=(e,t,r,o)=>e.status(o).render("error",{title:t,msg:r}),er=(e,t,r)=>t.originalUrl.startsWith("/api")?e.isOperational?r.status(e.statusCode).json({status:e.status,message:e.message}):(console.log("ERROR",e),Zt(r)):e.isOperational?fe(r,"Something went wrong!",e.message,e.statusCode):(console.log("ERROR",e),fe(r,"Something went wrong!","Please try again later",e.statusCode)),tr=(e,t,r,o)=>{if(e.statusCode=e.statusCode||500,e.status=e.status||"error",process.env.NODE_ENV==="development")Xt(e,t,r);else if(process.env.NODE_ENV==="production"){let s=H({},e);s.message=e.message,e.name==="CastError"&&(s=zt(e)),e.code===11e3&&(s=Yt(e)),e.name==="ValidationError"&&(s=Gt(e)),e.name==="JsonWebTokenError"&&(s=Qt()),e.name==="TokenExpiredError"&&(s=Kt()),er(s,t,r)}},he=tr;var Et=u(require("express-rate-limit")),Pt=u(require("helmet")),$t=u(require("express-mongo-sanitize")),Ot=u(require("xss-clean")),It=u(require("hpp")),jt=u(require("cookie-parser")),Dt=u(require("compression")),ce=u(require("cors"));var ze=u(require("express"));var Z=u(require("multer")),X=u(require("sharp"));var F=u(require("mongoose")),ye=u(require("slugify")),R=new F.default.Schema({name:{type:String,required:[!0,"A tour must have a name"],unique:!0,trim:!0,maxlength:[40,"A tour name must have less or equal than 40 characters"],minlength:[10,"A tour name must have more or equal than 10 characters"]},slug:String,duration:{type:Number,required:[!0,"A tour must have a duration"]},maxGroupSize:{type:Number,required:[!0,"A tour must have a max group size"]},difficulty:{type:String,required:[!0,"A tour must have a difficulty"],enum:{values:["easy","medium","difficult"],message:"Difficulty is either:easy,medium,difficult "}},ratingsAverage:{type:Number,default:4.5,min:[1,"Rating must be above 1.0"],max:[5,"Rating must be above 5.0"],set:e=>Math.round(e*10)/10},ratingsQuantity:{type:Number,default:0},price:{type:Number,required:[!0,"A tour must have a price"]},priceDiscount:{type:Number,validate:{validator:function(e){return e<this.price},message:"Discount price ({VALUE}) should be below regular price"}},summary:{type:String,trim:!0,required:!0},description:{type:String,trim:!0},imageCover:{type:String,required:[!0,"A tour must have a cover image"]},images:[String],createdAt:{type:Date,default:Date.now,select:!1},startDates:[Date],secretTour:{type:Boolean,default:!1},startLocation:{type:{type:String,default:"Point",enum:["Point"]},coordinates:[Number],address:String,description:String},locations:[{type:{type:String,default:"Point",enum:["Point"]},coordinates:[Number],address:String,description:String,day:Number}],guides:[{type:F.default.Schema.Types.ObjectId,ref:"User"}]},{toJSON:{virtuals:!0},toObject:{virtuals:!0}});R.index({price:1,ratingsAverage:-1});R.index({slug:1});R.index({startLocation:"2dsphere"});R.virtual("durationWeeks").get(function(){return this.duration/7});R.virtual("reviews",{ref:"Review",foreignField:"tour",localField:"_id"});R.pre("save",function(e){this.slug=(0,ye.default)(this.name,{lower:!0}),e()});var kr=Date.now();R.pre(/^find/,function(e){this.find({secretTour:{$ne:!0}}),e()});R.pre(/^find/,function(e){this.populate({path:"guides",select:"-__v -passwordChangedAt -verifyToken"}),e()});R.pre("aggregate",function(e){let t={$match:{secretTour:{$ne:!0}}};this.pipeline().unshift(t);let r=this.pipeline().find(o=>o.$geoNear);if(r){let o=this.pipeline().findIndex(s=>s.$geoNear);this.pipeline().splice(o,1),this.pipeline().unshift(r)}e()});var rr=F.default.model("Tour",R),p=rr;var or=e=>(t,r,o)=>{e(t,r,o).catch(o)},c=or;var K=class{constructor(t,r){this.query=t,this.queryString=r}filter(){let t=H({},this.queryString);["page","sort","limit","fields"].forEach(s=>delete t[s]);let o=JSON.stringify(t);return o=o.replace(/\b(gte|gt|lte|lt)\b/g,s=>`$${s}`),this.query=this.query.find(JSON.parse(o)),this}sort(){if(this.queryString.sort){let t=this.queryString.sort.split(",").join(" ");this.query=this.query.sort(t)}else this.query.sort("-createdAt");return this}limitFields(){if(this.queryString.fields){let t=this.queryString.fields.split(",").join(" ");this.query=this.query.select(t)}else this.query.select("-__v");return this}paginate(){let t=this.queryString.page*1||1,r=this.queryString.limit*1||100,o=(t-1)*r;return this.query=this.query.skip(o).limit(r),this}},we=K;var b=e=>c((t,r,o)=>a(void 0,null,function*(){let s={};t.params.tourId&&(s={tour:t.params.tourId});let l=yield new we(e.find(s),t.query).filter().sort().limitFields().paginate().query;r.status(200).json({status:"success",results:l.length,data:l})})),x=(e,t)=>c((r,o,s)=>a(void 0,null,function*(){let n=e.findById(r.params.id);t&&(n=n.populate(t));let l=yield n;if(!l)return s(new i("No document found with that ID ",404));l.verifyToken=void 0,o.status(200).json({status:"success",results:l})})),S=e=>c((t,r,o)=>a(void 0,null,function*(){if(!(yield e.findByIdAndDelete(t.params.id)))return o(new i("No document found with that ID ",404));r.status(204).json({status:"success",data:null})})),k=e=>c((t,r,o)=>a(void 0,null,function*(){let s=yield e.findByIdAndUpdate(t.params.id,t.body,{new:!0,runValidators:!0}),n=e.modelName.toLowerCase();if(!s)return o(new i("No document found with that ID ",404));r.status(200).json({status:"success",data:{[n]:s}})})),$=e=>c((t,r,o)=>a(void 0,null,function*(){let s=yield e.create(t.body),n=e.modelName.toLowerCase();r.status(201).json({status:"success",data:{[n]:s}})}));var sr=Z.default.memoryStorage(),nr=(e,t,r)=>{t.mimetype.startsWith("image")?r(null,!0):r(new i("Not an image ! Please upload only images.",400),!1)},ar=(0,Z.default)({storage:sr,fileFilter:nr}),ve=ar.fields([{name:"imageCover",maxCount:1},{name:"images",maxCount:3}]),Re=c((e,t,r)=>a(void 0,null,function*(){let o=e.files.imageCover,s=e.files.images;o&&(e.body.imageCover=`tour-${e.params.id}-${Date.now()}-cover.jpeg`,yield(0,X.default)(e.files.imageCover[0].buffer).resize(2e3,1333).toFormat("jpeg").jpeg({quality:90}).toFile(`dist/public/img/tours/${e.body.imageCover}`)),s&&(e.body.images=[],yield Promise.all(e.files.images.map((n,l)=>a(void 0,null,function*(){let g=`tour-${e.params.id}-${Date.now()}-${l+1}.jpeg`;yield(0,X.default)(n.buffer).resize(2e3,1333).toFormat("jpeg").jpeg({quality:90}).toFile(`dist/public/img/tours/${g}`),e.body.images.push(g)})))),r()})),Te=(e,t,r)=>{e.query.limit="5",e.query.sort="-ratingsAverage,price",e.query.fields="name,price,ratingsAverage,summary,difficulty,duration",r()},ee=b(p),Ce=x(p,{path:"reviews"}),be=$(p),xe=k(p),Se=S(p),ke=c((e,t,r)=>a(void 0,null,function*(){let o=yield p.aggregate([{$match:{ratingsAverage:{$gte:4.5}}},{$group:{_id:{$toUpper:"$difficulty"},numTours:{$sum:1},numRatings:{$sum:"$ratingsQuantity"},avgRating:{$avg:"$ratingsAverage"},avgPrice:{$avg:"$price"},minPrice:{$min:"$price"},maxPrice:{$max:"$price"}}},{$sort:{avgPrice:1}}]);t.status(200).json({status:"success",data:o})})),Ae=c((e,t,r)=>a(void 0,null,function*(){let o=+e.params.year,s=yield p.aggregate([{$unwind:"$startDates"},{$match:{startDates:{$gte:new Date(`${o}-01-01`),$lte:new Date(`${o}-12-31`)}}},{$group:{_id:{$month:"$startDates"},numTourStarts:{$sum:1},tours:{$push:"$name"}}},{$addFields:{month:"$_id"}},{$project:{_id:0}},{$sort:{numTourStarts:-1}},{$limit:12}]);t.status(200).json({status:"success",data:s})})),Ee=c((e,t,r)=>a(void 0,null,function*(){let{distance:o,latlng:s,unit:n}=e.params,[l,g]=s.split(","),f=n==="mi"?+o/3963.2:+o/6378.1;(!l||!g)&&r(new i("Please provide latitude and longitude in the format lat,lng",400));let v=yield p.find({startLocation:{$geoWithin:{$centerSphere:[[g,l],f]}}});t.status(200).json({status:"success",results:v.length,data:{data:v}})})),Pe=c((e,t,r)=>a(void 0,null,function*(){let{latlng:o,unit:s}=e.params,[n,l]=o.split(","),g=s==="mi"?621371e-9:.001;(!n||!l)&&new i("Please provide latitude and longitude in the format lat,lng",400);let f=yield p.aggregate([{$geoNear:{near:{type:"Point",coordinates:[+l,+n]},distanceField:"distance",distanceMultiplier:g}},{$project:{distance:1,name:1}}]);t.status(200).json({status:"success",data:{data:f}})}));var se=u(require("crypto")),L=u(require("jsonwebtoken"));var D=u(require("crypto")),te=u(require("mongoose")),$e=u(require("validator")),re=u(require("bcryptjs"));var A=new te.default.Schema({name:{type:String,required:[!0,"Please tell us your name"]},email:{type:String,required:[!0,"Please provide your email"],unique:!0,lowercase:!0,validate:[$e.default.isEmail,"Please provide a valid email"]},photo:{type:String,default:"default.jpg"},role:{type:String,enum:["user","guide","lead-guide","admin"],default:"user"},password:{type:String,required:[!0,"Please provide your password"],minlength:8,select:!1},passwordConfirm:{type:String,required:[!0,"Please confirm your password"],validate:{validator:function(e){return e===this.password},message:"Passwords are not the same"}},passwordChangedAt:Date,passwordResetToken:String,passwordResetExpires:Date,active:{type:Boolean,default:!0,select:!1},verifyToken:String,verified:{type:Boolean,default:!1,select:!1}});A.pre("save",function(e){return a(this,null,function*(){if(!this.isModified("password"))return e();this.password=yield re.default.hash(this.password,12),this.passwordConfirm=void 0,e()})});A.pre("save",function(e){if(!this.isModified("password")||this.isNew)return e();this.passwordChangedAt=Date.now()-1e3,e()});A.pre(/^find/,function(e){this.find({active:{$ne:!1}}),e()});A.methods.correctPassword=function(e,t){return a(this,null,function*(){return yield re.default.compare(e,t)})};A.methods.changesPasswordAfter=function(e){if(this.passwordChangedAt){let t=this.passwordChangedAt.getTime()/1e3;return e<t}return!1};A.methods.createPasswordResetToken=function(){let e=D.default.randomBytes(32).toString("hex");return this.passwordResetToken=D.default.createHash("sha256").update(e).digest("hex"),this.passwordResetExpires=Date.now()+10*60*1e3,e};A.methods.verifyEmailToken=function(){let e=D.default.randomBytes(32).toString("hex");return this.verifyToken=D.default.createHash("sha256").update(e).digest("hex"),e};var ur=te.default.model("User",A),m=ur;var oe=u(require("nodemailer")),Oe=u(require("pug")),Ie=require("html-to-text");var N=class{constructor(t,r){this.to=t.email,this.firstName=t.name.split(" ")[0],this.url=r,this.from=`Chamara Perera <${process.env.EMAIL_FROM}>`}newTransport(){return process.env.NODE_ENV==="production"?oe.default.createTransport({service:"SendInBlue",auth:{user:process.env.SENDINBLUE_USERNAME,pass:process.env.SENDINBLUE_PASSWORD}}):oe.default.createTransport({host:process.env.EMAIL_HOST,port:Number(process.env.EMAIL_PORT),auth:{user:process.env.EMAIL_USERNAME,pass:process.env.EMAIL_PASSWORD}})}send(t,r){return a(this,null,function*(){let o=Oe.default.renderFile(`${__dirname}/views/email/${t}.pug`,{firstName:this.firstName,url:this.url,subject:r}),s={from:this.from,to:this.to,subject:r,html:o,text:(0,Ie.htmlToText)(o)};yield this.newTransport().sendMail(s)})}sendWelcome(){return a(this,null,function*(){yield this.send("Welcome","Welcome to the Nature Sights Family")})}sendPasswordReset(){return a(this,null,function*(){yield this.send("passwordReset","Your password reset token (valid for only 10 minutes)")})}};var _=u(require("mongoose"));var O=new _.default.Schema({review:{type:String,required:[!0,"Review cannot be empty"]},rating:{type:Number,min:1,max:5,required:[!0,"Rating cannot be empty"]},createdAt:{type:Date,default:Date.now()},tour:{type:_.default.Schema.Types.ObjectId,ref:"Tour",required:[!0,"Review must belong to a tour"]},user:{type:_.default.Schema.Types.ObjectId,ref:"User",required:[!0,"Review must belong to a user"]}},{toJSON:{virtuals:!0},toObject:{virtuals:!0}});O.index({tour:1,user:1},{unique:!0});O.pre(/^find/,function(e){this.populate({path:"user",select:"name photo"}),e()});O.statics.calcAverageRatings=function(e){return a(this,null,function*(){let t=yield this.aggregate([{$match:{tour:e}},{$group:{_id:"$tour",nRating:{$sum:1},avgRating:{$avg:"$rating"}}}]);t.length>0?yield p.findByIdAndUpdate(e,{ratingsQuantity:t[0].nRating,ratingsAverage:t[0].avgRating}):yield p.findByIdAndUpdate(e,{ratingsQuantity:0,ratingsAverage:4.5})})};O.post("save",function(){this.constructor.calcAverageRatings(this.tour)});O.post(/^findOneAnd/,function(e){e.constructor.calcAverageRatings(e.tour)});var lr=_.default.model("Review",O),E=lr;var cr=e=>{let t=process.env.JWT_SECRET;if(!t)throw new Error("JWT secret is not defined");return L.default.sign({id:e},t,{expiresIn:process.env.JWT_EXPIRES_IN})},J=(e,t,r,o)=>{let s=cr(e._id),n={expires:new Date(Date.now()+Number(process.env.JWT_COOKIE_EXPIRES_IN)*24*60*60*1e3),httpOnly:!0,secure:r.secure||r.headers["x-forwarded-proto"]==="https"};o.cookie("jwt",s,n),e.password=void 0,e.verifyToken=void 0,o.status(t).json({status:"success",token:s,data:{user:e}})},je=c((e,t,r)=>a(void 0,null,function*(){let o=yield m.create({name:e.body.name,email:e.body.email,password:e.body.password,passwordConfirm:e.body.passwordConfirm,passwordChangedAt:e.body.passwordChangedAt,role:e.body.role,photo:e.body.photo}),s=`${e.protocol}://${e.get("host")}/me`;yield new N(o,s).sendWelcome();let n=o.verifyEmailToken();yield o.save({validateModifiedOnly:!0});let g=`Please go to this link to verify your email :${`${e.protocol}://${e.get("host")}/api/v1/users/verifyEmail/${n}`}.
 If you didn't create an account,
  please ignore this email`;try{}catch(f){return o.verifyToken=void 0,yield o.save({validateModifiedOnly:!0}),r(new i("There was an error sending the email. Try again later!",500))}J(o,201,e,t)})),De=c((e,t,r)=>a(void 0,null,function*(){let o=se.default.createHash("sha256").update(e.params.token).digest("hex"),s=yield m.findOne({verifyToken:o}).select("+verified");if(!s)return r(new i("The token is invalid or has expired",400));if(s.verified)return r(new i("Email address has already been verified",400));s.verified=!0,yield s.save({validateModifiedOnly:!0}),t.status(200).json({status:"success",message:"Email address has been verified"})})),Ne=c((e,t,r)=>a(void 0,null,function*(){let{email:o,password:s}=e.body;if(!o||!s)return r(new i("Please provide email and password",400));let n=yield m.findOne({email:o}).select("+password");if(!n||!(yield n.correctPassword(s,n.password)))return r(new i("Incorrect email or password",401));J(n,200,e,t)})),_e=(e,t,r)=>{t.clearCookie("jwt"),t.status(200).json({status:"success"})},h=c((e,t,r)=>a(void 0,null,function*(){let o;if(e.headers.authorization&&e.headers.authorization.startsWith("Bearer")?o=e.headers.authorization.split(" ")[1]:e.cookies.jwt&&(o=e.cookies.jwt),!o)return r(new i("You are not logged in! Please log in to get access",401));let n=yield((g,f)=>new Promise((v,B)=>{L.default.verify(g,f,{},(M,Mt)=>{M?B(M):v(Mt)})}))(o,process.env.JWT_SECRET),l=yield m.findById(n.id);if(!l)return r(new i("The user belonging to this token  does no longer exist",401));if(l.changesPasswordAfter(n.iat))return r(new i("User recently changed password! Please log in again",401));e.user=l,t.locals.user=l,r()})),V=(e,t,r)=>a(void 0,null,function*(){try{if(e.cookies.jwt){let s=yield((l,g)=>new Promise((f,v)=>{L.default.verify(l,g,{},(B,M)=>{B?v(B):f(M)})}))(e.cookies.jwt,process.env.JWT_SECRET),n=yield m.findById(s.id);return!n||n.changesPasswordAfter(s.iat)||(t.locals.user=n),r()}r()}catch(o){return r()}}),w=(...e)=>(t,r,o)=>{if(!e.includes(t.user.role))return o(new i("You do not have permission to perform this action",403));o()},Ue=c((e,t,r)=>a(void 0,null,function*(){let o=yield m.findOne({email:e.body.email});if(!o)return r(new i("There is no user with email address",404));let s=o.createPasswordResetToken();yield o.save({validateModifiedOnly:!0});try{let n=`${e.protocol}://${e.get("host")}/api/v1/users/resetPassword/${s}`;yield new N(o,n).sendPasswordReset(),t.status(200).json({status:"success",message:"Token sent to email"})}catch(n){return o.passwordResetToken=void 0,o.passwordResetExpires=void 0,yield o.save({validateModifiedOnly:!0}),r(new i("There was an error sending the email. Try again later!",500))}})),qe=c((e,t,r)=>a(void 0,null,function*(){let o=se.default.createHash("sha256").update(e.params.token).digest("hex"),s=yield m.findOne({passwordResetToken:o,passwordResetExpires:{$gt:Date.now()}});if(!s)return r(new i("The token is invalid or has expired",400));s.password=e.body.password,s.passwordConfirm=e.body.passwordConfirm,s.passwordResetToken=void 0,s.passwordResetExpires=void 0,yield s.save(),J(s,200,e,t)})),Be=c((e,t,r)=>a(void 0,null,function*(){let o=yield m.findById(e.user._id).select("+password");if(!o)return r(new i("The user does not exist",400));if(!(yield o.correctPassword(e.body.passwordCurrent,o.password)))return r(new i("The password is wrong",401));o.password=e.body.password,o.passwordConfirm=e.body.passwordConfirm,yield o.save(),J(o,200,e,t)})),ne=c((e,t,r)=>a(void 0,null,function*(){let o=yield E.findById(e.params.id);e.user.role!=="admin"&&e.user.id!==(o==null?void 0:o.user.id)&&r(new i("Not Authorized. You cannot update or delete review written by someone else",403)),r()}));var Ve=u(require("express"));var Me=b(E),He=(e,t,r)=>{e.body.tour||(e.body.tour=e.params.tourId),e.body.user||(e.body.user=e.user.id),r()},Fe=x(E),We=$(E),Le=k(E),Je=S(E);var z=Ve.default.Router({mergeParams:!0});z.use(h);z.route("/").get(Me).post(w("user"),He,We);z.route("/:id").get(Fe).patch(w("user","admin"),ne,Le).delete(w("user","admin"),ne,Je);var Y=z;var T=ze.default.Router();T.use("/:tourId/reviews",Y);T.route("/tour-stats").get(ke);T.route("/monthly-plan/:year").get(h,w("admin","lead-guide","guide"),Ae);T.route("/tours-within/:distance/center/:latlng/unit/:unit").get(Ee);T.route("/distances/:latlng/unit/:unit").get(Pe);T.route("/top-5-cheap").get(Te,ee);T.route("/").get(ee).post(h,w("admin","lead-guide"),be);T.route("/:id").get(Ce).patch(h,w("admin","lead-guide"),ve,Re,xe).delete(h,w("admin","lead-guide"),Se);var Ye=T;var nt=u(require("express"));var ae=u(require("multer")),Ge=u(require("sharp"));var pr=ae.default.memoryStorage(),mr=(e,t,r)=>{t.mimetype.startsWith("image")?r(null,!0):r(new i("Not an image ! Please upload only images.",400),!1)},gr=(0,ae.default)({storage:pr,fileFilter:mr}),Qe=gr.single("photo"),Ke=c((e,t,r)=>a(void 0,null,function*(){if(!e.file)return r();e.file.filename=`user-${e.user.id}-${Date.now()}.jpeg`,yield(0,Ge.default)(e.file.buffer).resize(500,500).toFormat("jpeg").jpeg({quality:90}).toFile(`dist/public/img/users/${e.file.filename}`),r()})),fr=(e,...t)=>{let r={},o=[];return Object.keys(e).forEach(s=>{t.includes(s)?r[s]=e[s]:o.push(s)}),{allowed:r,notAllowed:o}},Xe=b(m),Ze=c((e,t,r)=>a(void 0,null,function*(){if(e.body.password||e.body.passwordConfirm)return r(new i("This route is not for password updates.Please use /updateMyPassword",400));let o=fr(e.body,"name","email");e.file&&(o.allowed.photo=e.file.filename);let{allowed:s,notAllowed:n}=o;Object.keys(s).length===0&&n.length>0&&t.status(400).json({status:"fail",message:`Not allowed fields found: ${n.join(", ")}`});let l=yield m.findByIdAndUpdate(e.user.id,s,{new:!0,runValidators:!0});n.length>0?t.status(400).json({status:"partial",message:`Unable to update these fields: ${n.join(", ")}`,data:{user:l}}):t.status(200).json({status:"success",data:{user:l}})})),et=(e,t,r)=>{e.params.id=e.user.id,r()},tt=c((e,t,r)=>a(void 0,null,function*(){yield m.findByIdAndUpdate(e.user.id,{active:!1}),t.status(204).json({status:"success",data:null})})),rt=(e,t)=>{t.status(500).json({status:"error",message:"This route is not not defined. Please use /signup instead "})},ie=x(m),ot=k(m),st=S(m);var y=nt.default.Router();y.post("/signup",je);y.get("/verifyEmail/:token",De);y.post("/login",Ne);y.get("/logout",_e);y.post("/forgotPassword",Ue);y.patch("/resetPassword/:token",qe);y.use(h);y.get("/me",et,ie);y.patch("/updateMyPassword",Be);y.patch("/updateMe",Qe,Ke,Ze);y.delete("/deleteMe",tt);y.use(w("admin"));y.route("/").get(Xe).post(rt);y.route("/:id").get(ie).patch(ot).delete(st);var at=y;var ft=u(require("express"));var q=u(require("mongoose")),it=new q.default.Schema({tour:{type:q.default.Schema.Types.ObjectId,ref:"Tour",required:[!0,"Booking must belong to a tour"]},user:{type:q.default.Schema.Types.ObjectId,ref:"User",required:[!0,"Booking must belong to a user"]},price:{type:Number,required:[!0,"Booking must have a price"]},createdAt:{type:Date,default:Date.now()},paid:{type:Boolean,default:!0}});it.pre(/^find/,function(e){this.populate("user").populate({path:"tour",select:"name"}),e()});var yr=q.default.model("Booking",it),C=yr;var ut=(e,t,r)=>{let{alert:o}=e.query;o==="booking"&&(t.locals.alert="Your booking was successful! Please check your email for a confirmation. If your booking does not show up here immediately, please come back later."),r()},lt=c((e,t,r)=>a(void 0,null,function*(){let o=yield p.find();t.status(200).render("overview",{title:"All tours",tours:o})})),ct=c((e,t,r)=>a(void 0,null,function*(){let o=yield p.findOne({slug:e.params.slug}).populate({path:"reviews",select:"review rating user"});if(!o)return r(new i("There is no tour with that name.",404));t.status(200).render("tour",{title:`${o.name} tour`,tour:o})})),dt=(e,t)=>{t.status(200).render("login",{title:"Log into your account"})},pt=(e,t)=>{t.status(200).render("signup",{title:"Signup"})},mt=(e,t)=>{t.status(200).render("account",{title:"Your account"})},gt=c((e,t,r)=>a(void 0,null,function*(){let s=(yield C.find({user:e.user.id})).map(l=>l.tour),n=yield p.find({_id:{$in:s}});t.status(200).render("overview",{title:"My Tours",tours:n})}));var P=ft.default.Router();P.use(ut);P.get("/",V,lt);P.get("/tour/:slug",V,ct);P.get("/login",V,dt);P.get("/signup",pt);P.get("/me",h,mt);P.get("/my-tours",h,gt);var ht=P;var St=u(require("express"));var ue=u(require("stripe"));var yt=c((e,t,r)=>a(void 0,null,function*(){let o=new ue.default(process.env.STRIPE_SECRET_KEY,{apiVersion:"2022-11-15"}),s=yield p.findById(e.params.tourId);if(s){let n=yield o.checkout.sessions.create({line_items:[{quantity:1,price_data:{currency:"aud",unit_amount:s.price*100,product_data:{name:`${s.name} Tour`,description:s.summary,images:[`${e.protocol}://${e.get("host")}/img/tours/${s.imageCover}`]}}}],mode:"payment",success_url:`${e.protocol}://${e.get("host")}/my-tours?alert=booking`,cancel_url:`${e.protocol}://${e.get("host")}/tour/${s.slug}`,client_reference_id:e.params.tourId,customer_email:e.user.email});t.status(200).json({status:"success",session:n})}})),vr=e=>a(void 0,null,function*(){var s;let t=e.client_reference_id,r=(s=yield m.findOne({email:e.customer_email}))==null?void 0:s.id,o=e.amount_total/100;yield C.create({tour:t,user:r,price:o})}),wt=(e,t,r)=>{let o=new ue.default(process.env.STRIPE_SECRET_KEY,{apiVersion:"2022-11-15"}),s=e.headers["stripe-signature"],n;try{n=o.webhooks.constructEvent(e.body,s,process.env.STRIPE_WEBHOOK_SECRET)}catch(l){return t.status(400).send(`Webhook error: ${l.message}`)}n.type==="checkout.session.completed"&&vr(n.data.object),t.status(200).json({received:!0})},vt=$(C),Rt=b(C),Tt=x(C),Ct=k(C),bt=S(C);var I=St.default.Router();I.use(h);I.get("/checkout-session/:tourId",h,yt);I.use(w("lead-guide","admin"));I.route("/").get(Rt).post(vt);I.route("/:id").get(Tt).patch(Ct).delete(bt);var kt=I;var d=(0,j.default)();d.enable("trust proxy");d.set("view engine","pug");d.set("views",le.default.join(__dirname,"views"));d.use((0,ce.default)());d.options("*",(0,ce.default)());d.use(j.default.static(le.default.join(__dirname,"public")));d.use(Pt.default.crossOriginResourcePolicy({policy:"same-origin"}));process.env.NODE_ENV==="development"&&d.use((0,At.default)("dev"));var Rr=(0,Et.default)({max:100,windowMs:60*60*1e3,message:"Too many request from this IP,please try again in an hour"});d.use("/api",Rr);d.post("/webhook-checkout",j.default.raw({type:"application/json"}),wt);d.use(j.default.json({limit:"10kb"}));d.use((0,jt.default)());d.use(j.default.urlencoded({extended:!0,limit:"10kb"}));d.use((0,$t.default)());d.use((0,Ot.default)());d.use((0,It.default)({whitelist:["duration","ratingsQuantity","ratingsAverage","maxGroupSize","difficulty","price"]}));d.use((0,Dt.default)());d.use((e,t,r)=>{e.RequestTime=new Date().toISOString(),r()});d.use("/",ht);d.use("/api/v1/tours",Ye);d.use("/api/v1/users",at);d.use("/api/v1/reviews",Y);d.use("/api/v1/bookings",kt);d.all("*",(e,t,r)=>{r(new i(`Can't find ${e.originalUrl} on this server!`,404))});d.use(he);var Nt=d;process.on("uncaughtException",e=>{console.log(e.name,e.message),console.log("UNCAUGHT EXCEPTION! Shutting down..."),process.exit(1)});Ut.default.config({path:"./.env"});var qt="";process.env.DATABASE&&process.env.DATABASE_PASSWORD&&(qt=process.env.DATABASE.replace("<PASSWORD>",process.env.DATABASE_PASSWORD));de.default.set("strictQuery",!0);de.default.connect(qt).then(()=>{console.log("DB connection successful")});var _t=process.env.PORT||3e3,Bt=Nt.listen(_t,()=>console.log(`App running on ${_t}...`));process.on("unhandledRejection",e=>{console.log(e.name,e.message),console.log("UNHANDLED REJECTION! Shutting down..."),Bt.close(()=>process.exit(1))});process.on("SIGTERM",()=>{console.log("SIGTERM RECEIVED. Shutting down gracefully"),Bt.close(()=>console.log("Process terminated"))});
