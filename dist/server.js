"use strict";var Yt=Object.create;var Q=Object.defineProperty;var Gt=Object.getOwnPropertyDescriptor;var Qt=Object.getOwnPropertyNames,me=Object.getOwnPropertySymbols,Kt=Object.getPrototypeOf,fe=Object.prototype.hasOwnProperty,Xt=Object.prototype.propertyIsEnumerable;var ge=(e,t,r)=>t in e?Q(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,B=(e,t)=>{for(var r in t||={})fe.call(t,r)&&ge(e,r,t[r]);if(me)for(var r of me(t))Xt.call(t,r)&&ge(e,r,t[r]);return e};var Zt=(e,t,r,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of Qt(t))!fe.call(e,s)&&s!==r&&Q(e,s,{get:()=>t[s],enumerable:!(o=Gt(t,s))||o.enumerable});return e};var u=(e,t,r)=>(r=e!=null?Yt(Kt(e)):{},Zt(t||!e||!e.__esModule?Q(r,"default",{value:e,enumerable:!0}):r,e));var a=(e,t,r)=>new Promise((o,s)=>{var n=h=>{try{g(r.next(h))}catch(R){s(R)}},d=h=>{try{g(r.throw(h))}catch(R){s(R)}},g=h=>h.done?o(h.value):Promise.resolve(h.value).then(n,d);g((r=r.apply(e,t)).next())});var pe=u(require("mongoose")),Wt=u(require("dotenv"));var de=u(require("path")),I=u(require("express")),Dt=u(require("morgan"));var K=class extends Error{constructor(r,o){super(r);this.statusCode=o,this.status=`${o}`.startsWith("4")?"fail":"error",this.isOperational=!0,Error.captureStackTrace(this,this.constructor)}},i=K;var er=e=>{let t=`Invalid ${e.path}:${e.value}`;return new i(t,400)},tr=e=>{let r=`Duplicate field value: '${e.keyValue.name}' Please use another value`;return new i(r,400)},rr=e=>{let r=`Invalid input data. ${Object.values(e.errors).map(o=>o.message).join(". ")}`;return new i(r,400)},or=()=>new i("Invalid token. Please log in again",401),sr=()=>new i("Your token has expired! Please log in again",401),nr=(e,t,r)=>t.originalUrl.startsWith("/api")?r.status(e.statusCode).json({status:e.status,error:e,message:e.message,stack:e.stack}):(console.log("ERROR",e),r.status(e.statusCode).render("error",{title:"Something went wrong!",msg:e.message})),ar=e=>e.status(500).json({status:"error",message:"Something went wrong"}),he=(e,t,r,o)=>e.status(o).render("error",{title:t,msg:r}),ir=(e,t,r)=>t.originalUrl.startsWith("/api")?e.isOperational?r.status(e.statusCode).json({status:e.status,message:e.message}):(console.log("ERROR",e),ar(r)):e.isOperational?he(r,"Something went wrong!",e.message,e.statusCode):(console.log("ERROR",e),he(r,"Something went wrong!","Please try again later",e.statusCode)),ur=(e,t,r,o)=>{if(e.statusCode=e.statusCode||500,e.status=e.status||"error",process.env.NODE_ENV==="development")nr(e,t,r);else if(process.env.NODE_ENV==="production"){let s=B({},e);s.message=e.message,e.name==="CastError"&&(s=er(e)),e.code===11e3&&(s=tr(e)),e.name==="ValidationError"&&(s=rr(e)),e.name==="JsonWebTokenError"&&(s=or()),e.name==="TokenExpiredError"&&(s=sr()),ir(s,t,r)}},ye=ur;var _t=u(require("express-rate-limit")),Nt=u(require("helmet")),Ut=u(require("express-mongo-sanitize")),qt=u(require("xss-clean")),Ht=u(require("hpp")),Mt=u(require("cookie-parser")),Bt=u(require("compression")),ce=u(require("cors"));var Ge=u(require("express"));var Z=u(require("path")),te=u(require("multer")),ee=u(require("sharp"));var F=u(require("mongoose")),we=u(require("slugify")),C=new F.default.Schema({name:{type:String,required:[!0,"A tour must have a name"],unique:!0,trim:!0,maxlength:[40,"A tour name must have less or equal than 40 characters"],minlength:[10,"A tour name must have more or equal than 10 characters"]},slug:String,duration:{type:Number,required:[!0,"A tour must have a duration"]},maxGroupSize:{type:Number,required:[!0,"A tour must have a max group size"]},difficulty:{type:String,required:[!0,"A tour must have a difficulty"],enum:{values:["easy","medium","difficult"],message:"Difficulty is either:easy,medium,difficult "}},ratingsAverage:{type:Number,default:4.5,min:[1,"Rating must be above 1.0"],max:[5,"Rating must be above 5.0"],set:e=>Math.round(e*10)/10},ratingsQuantity:{type:Number,default:0},price:{type:Number,required:[!0,"A tour must have a price"]},priceDiscount:{type:Number,validate:{validator:function(e){return e<this.price},message:"Discount price ({VALUE}) should be below regular price"}},summary:{type:String,trim:!0,required:!0},description:{type:String,trim:!0},imageCover:{type:String,required:[!0,"A tour must have a cover image"]},images:[String],createdAt:{type:Date,default:Date.now,select:!1},startDates:[Date],secretTour:{type:Boolean,default:!1},startLocation:{type:{type:String,default:"Point",enum:["Point"]},coordinates:[Number],address:String,description:String},locations:[{type:{type:String,default:"Point",enum:["Point"]},coordinates:[Number],address:String,description:String,day:Number}],guides:[{type:F.default.Schema.Types.ObjectId,ref:"User"}]},{toJSON:{virtuals:!0},toObject:{virtuals:!0}});C.index({price:1,ratingsAverage:-1});C.index({slug:1});C.index({startLocation:"2dsphere"});C.virtual("durationWeeks").get(function(){return this.duration/7});C.virtual("reviews",{ref:"Review",foreignField:"tour",localField:"_id"});C.pre("save",function(e){this.slug=(0,we.default)(this.name,{lower:!0}),e()});C.pre(/^find/,function(e){this.populate({path:"guides",select:"-__v -passwordChangedAt -verifyToken"}),e()});C.pre("aggregate",function(e){let t={$match:{secretTour:{$ne:!0}}};this.pipeline().unshift(t);let r=this.pipeline().find(o=>o.$geoNear);if(r){let o=this.pipeline().findIndex(s=>s.$geoNear);this.pipeline().splice(o,1),this.pipeline().unshift(r)}e()});var lr=F.default.model("Tour",C),m=lr;var dr=e=>(t,r,o)=>{e(t,r,o).catch(o)},l=dr;var X=class{constructor(t,r){this.query=t,this.queryString=r}filter(){let t=B({},this.queryString);["page","sort","limit","fields"].forEach(s=>delete t[s]);let o=JSON.stringify(t);return o=o.replace(/\b(gte|gt|lte|lt)\b/g,s=>`$${s}`),this.query=this.query.find(JSON.parse(o)),this}sort(){if(this.queryString.sort){let t=this.queryString.sort.split(",").join(" ");this.query=this.query.sort(t)}else this.query.sort("-createdAt");return this}limitFields(){if(this.queryString.fields){let t=this.queryString.fields.split(",").join(" ");this.query=this.query.select(t)}else this.query.select("-__v");return this}paginate(){let t=this.queryString.page*1||1,r=this.queryString.limit*1||100,o=(t-1)*r;return this.query=this.query.skip(o).limit(r),this}},ve=X;var S=e=>l((t,r,o)=>a(void 0,null,function*(){let s={};t.params.tourId&&(s={tour:t.params.tourId});let d=yield new ve(e.find(s),t.query).filter().sort().limitFields().paginate().query;r.status(200).json({status:"success",results:d.length,data:d})})),k=(e,t)=>l((r,o,s)=>a(void 0,null,function*(){let n=e.findById(r.params.id);t&&(n=n.populate(t));let d=yield n;if(!d)return s(new i("No document found with that ID ",404));d.verifyToken=void 0,o.status(200).json({status:"success",results:d})})),E=e=>l((t,r,o)=>a(void 0,null,function*(){if(!(yield e.findByIdAndDelete(t.params.id)))return o(new i("No document found with that ID ",404));r.status(204).json({status:"success",data:null})})),A=e=>l((t,r,o)=>a(void 0,null,function*(){let s=yield e.findByIdAndUpdate(t.params.id,t.body,{new:!0,runValidators:!0}),n=e.modelName.toLowerCase();if(!s)return o(new i("No document found with that ID ",404));r.status(200).json({status:"success",data:{[n]:s}})})),O=e=>l((t,r,o)=>a(void 0,null,function*(){let s=yield e.create(t.body),n=e.modelName.toLowerCase();r.status(201).json({status:"success",data:{[n]:s}})}));var cr=te.default.memoryStorage(),pr=(e,t,r)=>{t.mimetype.startsWith("image")?r(null,!0):r(new i("Not an image ! Please upload only images.",400),!1)},mr=(0,te.default)({storage:cr,fileFilter:pr}),Re=mr.fields([{name:"imageCover",maxCount:1},{name:"images",maxCount:3}]),Te=l((e,t,r)=>a(void 0,null,function*(){let o=e.files.imageCover,s=e.files.images;o&&(e.body.imageCover=`tour-${e.params.id}-${Date.now()}-cover.jpeg`,yield(0,ee.default)(e.files.imageCover[0].buffer).resize(2e3,1333).toFormat("jpeg").jpeg({quality:90}).toFile(Z.default.join(__dirname,"public","img","tours",e.body.imageCover))),s&&(e.body.images=[],yield Promise.all(e.files.images.map((n,d)=>a(void 0,null,function*(){let g=`tour-${e.params.id}-${Date.now()}-${d+1}.jpeg`;yield(0,ee.default)(n.buffer).resize(2e3,1333).toFormat("jpeg").jpeg({quality:90}).toFile(Z.default.join(__dirname,"public","img","tours",g)),e.body.images.push(g)})))),r()})),Ce=(e,t,r)=>{e.query.limit="5",e.query.sort="-ratingsAverage,price",e.query.fields="name,price,ratingsAverage,summary,difficulty,duration",r()},re=S(m),xe=k(m,{path:"reviews"}),be=O(m),Se=A(m),ke=E(m),Ee=l((e,t,r)=>a(void 0,null,function*(){let o=yield m.aggregate([{$match:{ratingsAverage:{$gte:4.5}}},{$group:{_id:{$toUpper:"$difficulty"},numTours:{$sum:1},numRatings:{$sum:"$ratingsQuantity"},avgRating:{$avg:"$ratingsAverage"},avgPrice:{$avg:"$price"},minPrice:{$min:"$price"},maxPrice:{$max:"$price"}}},{$sort:{avgPrice:1}}]);t.status(200).json({status:"success",data:o})})),Ae=l((e,t,r)=>a(void 0,null,function*(){let o=+e.params.year,s=yield m.aggregate([{$unwind:"$startDates"},{$match:{startDates:{$gte:new Date(`${o}-01-01`),$lte:new Date(`${o}-12-31`)}}},{$group:{_id:{$month:"$startDates"},numTourStarts:{$sum:1},tours:{$push:"$name"}}},{$addFields:{month:"$_id"}},{$project:{_id:0}},{$sort:{numTourStarts:-1}},{$limit:12}]);t.status(200).json({status:"success",data:s})})),Pe=l((e,t,r)=>a(void 0,null,function*(){let{distance:o,latlng:s,unit:n}=e.params,[d,g]=s.split(","),h=n==="mi"?+o/3963.2:+o/6378.1;(!d||!g)&&r(new i("Please provide latitude and longitude in the format lat,lng",400));let R=yield m.find({startLocation:{$geoWithin:{$centerSphere:[[g,d],h]}}});t.status(200).json({status:"success",results:R.length,data:{data:R}})})),Oe=l((e,t,r)=>a(void 0,null,function*(){let{latlng:o,unit:s}=e.params,[n,d]=o.split(","),g=s==="mi"?621371e-9:.001;(!n||!d)&&new i("Please provide latitude and longitude in the format lat,lng",400);let h=yield m.aggregate([{$geoNear:{near:{type:"Point",coordinates:[+d,+n]},distanceField:"distance",distanceMultiplier:g}},{$project:{distance:1,name:1}}]);t.status(200).json({status:"success",data:{data:h}})}));var W=u(require("crypto")),V=u(require("jsonwebtoken"));var D=u(require("crypto")),oe=u(require("mongoose")),$e=u(require("validator")),se=u(require("bcryptjs"));var P=new oe.default.Schema({name:{type:String,required:[!0,"Please tell us your name"]},email:{type:String,required:[!0,"Please provide your email"],unique:!0,lowercase:!0,validate:[$e.default.isEmail,"Please provide a valid email"]},photo:{type:String,default:"default.jpg"},role:{type:String,enum:["user","guide","lead-guide","admin"],default:"user"},password:{type:String,required:[!0,"Please provide your password"],minlength:8,select:!1},passwordConfirm:{type:String,required:[!0,"Please confirm your password"],validate:{validator:function(e){return e===this.password},message:"Passwords are not the same"}},passwordChangedAt:Date,passwordResetToken:String,passwordResetExpires:Date,active:{type:Boolean,default:!0,select:!1},verifyToken:String,verified:{type:Boolean,default:!1,select:!1}});P.pre("save",function(e){return a(this,null,function*(){if(!this.isModified("password"))return e();this.password=yield se.default.hash(this.password,12),this.passwordConfirm=void 0,e()})});P.pre("save",function(e){if(!this.isModified("password")||this.isNew)return e();this.passwordChangedAt=Date.now()-1e3,e()});P.pre(/^find/,function(e){this.find({active:{$ne:!1}}),e()});P.methods.correctPassword=function(e,t){return a(this,null,function*(){return yield se.default.compare(e,t)})};P.methods.changesPasswordAfter=function(e){if(this.passwordChangedAt){let t=this.passwordChangedAt.getTime()/1e3;return e<t}return!1};P.methods.createPasswordResetToken=function(){let e=D.default.randomBytes(32).toString("hex");return this.passwordResetToken=D.default.createHash("sha256").update(e).digest("hex"),this.passwordResetExpires=Date.now()+10*60*1e3,e};P.methods.verifyEmailToken=function(){let e=D.default.randomBytes(32).toString("hex");return this.verifyToken=D.default.createHash("sha256").update(e).digest("hex"),e};var fr=oe.default.model("User",P),p=fr;var ne=u(require("nodemailer")),je=u(require("pug")),Ie=require("html-to-text");var _=class{constructor(t,r,o=null){this.to=t.email,this.firstName=t.name.split(" ")[0],this.url=r,this.confirmURL=o,this.from=`Nature Sights <${process.env.EMAIL_FROM}>`}newTransport(){return process.env.NODE_ENV==="production"?ne.default.createTransport({service:"SendInBlue",auth:{user:process.env.SENDINBLUE_USERNAME,pass:process.env.SENDINBLUE_PASSWORD}}):ne.default.createTransport({host:process.env.EMAIL_HOST,port:Number(process.env.EMAIL_PORT),auth:{user:process.env.EMAIL_USERNAME,pass:process.env.EMAIL_PASSWORD}})}send(t,r){return a(this,null,function*(){let o=je.default.renderFile(`${__dirname}/views/email/${t}.pug`,{firstName:this.firstName,url:this.url,confirmURL:this.confirmURL,subject:r}),s={from:this.from,to:this.to,subject:r,html:o,text:(0,Ie.htmlToText)(o)};yield this.newTransport().sendMail(s)})}sendWelcome(){return a(this,null,function*(){yield this.send("welcome","Welcome to the Nature Sights Family")})}sendPasswordReset(){return a(this,null,function*(){yield this.send("passwordReset","Your password reset token (valid for only 10 minutes)")})}};var N=u(require("mongoose"));var $=new N.default.Schema({review:{type:String,required:[!0,"Review cannot be empty"]},rating:{type:Number,min:1,max:5,required:[!0,"Rating cannot be empty"]},createdAt:{type:Date,default:Date.now()},tour:{type:N.default.Schema.Types.ObjectId,ref:"Tour",required:[!0,"Review must belong to a tour"]},user:{type:N.default.Schema.Types.ObjectId,ref:"User",required:[!0,"Review must belong to a user"]}},{toJSON:{virtuals:!0},toObject:{virtuals:!0}});$.index({tour:1,user:1},{unique:!0});$.pre(/^find/,function(e){this.populate({path:"user",select:"name photo"}).populate({path:"tour",select:"name imageCover"}),e()});$.statics.calcAverageRatings=function(e){return a(this,null,function*(){let t=yield this.aggregate([{$match:{tour:e}},{$group:{_id:"$tour",nRating:{$sum:1},avgRating:{$avg:"$rating"}}}]);t.length>0?yield m.findByIdAndUpdate(e,{ratingsQuantity:t[0].nRating,ratingsAverage:t[0].avgRating}):yield m.findByIdAndUpdate(e,{ratingsQuantity:0,ratingsAverage:4.5})})};$.post("save",function(){this.constructor.calcAverageRatings(this.tour)});$.post(/^findOneAnd/,function(e){e.constructor.calcAverageRatings(e.tour)});var hr=N.default.model("Review",$),T=hr;var yr=e=>{let t=process.env.JWT_SECRET;if(!t)throw new Error("JWT secret is not defined");return V.default.sign({id:e},t,{expiresIn:process.env.JWT_EXPIRES_IN})},J=(e,t,r,o)=>{let s=yr(e._id),n={expires:new Date(Date.now()+Number(process.env.JWT_COOKIE_EXPIRES_IN)*24*60*60*1e3),httpOnly:!0,secure:r.secure||r.headers["x-forwarded-proto"]==="https"};o.cookie("jwt",s,n),e.password=void 0,e.verifyToken=void 0,o.status(t).json({status:"success",token:s,data:{user:e}})},De=l((e,t,r)=>a(void 0,null,function*(){if(yield p.findOne({email:e.body.email}))return r(new i("You already have an account. Please Log In",400));let s=yield p.create({name:e.body.name,email:e.body.email,password:e.body.password,passwordConfirm:e.body.passwordConfirm,passwordChangedAt:e.body.passwordChangedAt,role:e.body.role,photo:e.body.photo}),n=s.verifyEmailToken();yield s.save({validateModifiedOnly:!0});let d=`${e.protocol}://${e.get("host")}/me`,g=`${e.protocol}://${e.get("host")}/email-confirm/${n}`;yield new _(s,d,g).sendWelcome(),J(s,201,e,t)})),_e=l((e,t,r)=>a(void 0,null,function*(){let o=W.default.createHash("sha256").update(e.params.token).digest("hex"),s=yield p.findOne({verifyToken:o}).select("+verified");if(!s)return r(new i("The token is invalid or has expired",400));if(s.verified)return r(new i("Email address has already been verified",400));s.verified=!0,yield s.save({validateModifiedOnly:!0}),t.status(200).json({status:"success",message:"Email address has been verified"})})),Ne=l((e,t,r)=>a(void 0,null,function*(){let{email:o,password:s}=e.body;if(!o||!s)return r(new i("Please provide email and password",400));let n=yield p.findOne({email:o}).select("+password");if(!n||!(yield n.correctPassword(s,n.password)))return r(new i("Incorrect email or password",401));J(n,200,e,t)})),Ue=(e,t,r)=>{t.clearCookie("jwt"),t.status(200).json({status:"success"})},f=l((e,t,r)=>a(void 0,null,function*(){let o;if(e.headers.authorization&&e.headers.authorization.startsWith("Bearer")?o=e.headers.authorization.split(" ")[1]:e.cookies.jwt&&(o=e.cookies.jwt),!o)return r(new i("You are not logged in! Please log in to get access",401));let n=yield((g,h)=>new Promise((R,H)=>{V.default.verify(g,h,{},(M,zt)=>{M?H(M):R(zt)})}))(o,process.env.JWT_SECRET),d=yield p.findById(n.id);if(!d)return r(new i("The user belonging to this token  does no longer exist",401));if(d.changesPasswordAfter(n.iat))return r(new i("User recently changed password! Please log in again",401));e.user=d,t.locals.user=d,r()})),z=(e,t,r)=>a(void 0,null,function*(){try{if(e.cookies.jwt){let s=yield((d,g)=>new Promise((h,R)=>{V.default.verify(d,g,{},(H,M)=>{H?R(H):h(M)})}))(e.cookies.jwt,process.env.JWT_SECRET),n=yield p.findById(s.id);return!n||n.changesPasswordAfter(s.iat)||(t.locals.user=n),r()}r()}catch(o){return r()}}),w=(...e)=>(t,r,o)=>{if(!e.includes(t.user.role))return o(new i("You do not have permission to perform this action",403));o()},qe=l((e,t,r)=>a(void 0,null,function*(){let o=yield p.findOne({email:e.body.email});if(!o)return r(new i("There is no user with email address",404));let s=o.createPasswordResetToken();yield o.save({validateModifiedOnly:!0});try{let n=`${e.protocol}://${e.get("host")}/reset-password/${s}`;yield new _(o,n).sendPasswordReset(),t.status(200).json({status:"success",message:"Token sent to email"})}catch(n){return o.passwordResetToken=void 0,o.passwordResetExpires=void 0,yield o.save({validateModifiedOnly:!0}),r(new i("There was an error sending the email. Try again later!",500))}})),He=l((e,t,r)=>a(void 0,null,function*(){let o=W.default.createHash("sha256").update(e.params.token).digest("hex"),s=yield p.findOne({passwordResetToken:o,passwordResetExpires:{$gt:Date.now()}});if(!s)return r(new i("The token is invalid or has expired",400));s.password=e.body.password,s.passwordConfirm=e.body.passwordConfirm,s.passwordResetToken=void 0,s.passwordResetExpires=void 0,yield s.save(),J(s,200,e,t)})),Me=l((e,t,r)=>a(void 0,null,function*(){let o=yield p.findById(e.user._id).select("+password");if(!o)return r(new i("The user does not exist",400));if(!(yield o.correctPassword(e.body.passwordCurrent,o.password)))return r(new i("The password is wrong",401));o.password=e.body.password,o.passwordConfirm=e.body.passwordConfirm,yield o.save(),J(o,200,e,t)})),ae=l((e,t,r)=>a(void 0,null,function*(){let o=yield T.findById(e.params.id);e.user.role!=="admin"&&e.user.id!==(o==null?void 0:o.user.id)&&r(new i("Not Authorized. You cannot update or delete review written by someone else",403)),r()})),Be=l((e,t,r)=>a(void 0,null,function*(){let o=W.default.createHash("sha256").update(e.params.token).digest("hex"),s=yield p.findOne({verifyToken:o}).select("+verified");if(!s)return r(new i("The token is invalid or has expired",400));if(s.verified)return r(new i("Email address has already been verified",400));s.verified=!0,yield s.save({validateModifiedOnly:!0}),t.locals.user=s,r()}));var Ye=u(require("express"));var Fe=S(T),Le=(e,t,r)=>{e.body.tour||(e.body.tour=e.params.tourId),e.body.user||(e.body.user=e.user.id),r()},We=k(T),Ve=O(T),Je=A(T),ze=E(T);var Y=Ye.default.Router({mergeParams:!0});Y.use(f);Y.route("/").get(Fe).post(w("user"),Le,Ve);Y.route("/:id").get(We).patch(w("user","admin"),ae,Je).delete(w("user","admin"),ae,ze);var G=Y;var x=Ge.default.Router();x.use("/:tourId/reviews",G);x.route("/tour-stats").get(Ee);x.route("/monthly-plan/:year").get(f,w("admin","lead-guide","guide"),Ae);x.route("/tours-within/:distance/center/:latlng/unit/:unit").get(Pe);x.route("/distances/:latlng/unit/:unit").get(Oe);x.route("/top-5-cheap").get(Ce,re);x.route("/").get(re).post(f,w("admin","lead-guide"),be);x.route("/:id").get(xe).patch(f,w("admin","lead-guide"),Re,Te,Se).delete(f,w("admin","lead-guide"),ke);var Qe=x;var ut=u(require("express"));var ie=u(require("multer")),Ke=u(require("sharp"));var Xe=u(require("path"));var vr=ie.default.memoryStorage(),Rr=(e,t,r)=>{t.mimetype.startsWith("image")?r(null,!0):r(new i("Not an image ! Please upload only images.",400),!1)},Tr=(0,ie.default)({storage:vr,fileFilter:Rr}),Ze=Tr.single("photo"),et=l((e,t,r)=>a(void 0,null,function*(){if(!e.file)return r();e.file.filename=`user-${e.user.id}-${Date.now()}.jpeg`,console.log(__dirname),yield(0,Ke.default)(e.file.buffer).resize(500,500).toFormat("jpeg").jpeg({quality:90}).toFile(Xe.default.join(__dirname,"public","img","users",e.file.filename)),r()})),Cr=(e,...t)=>{let r={},o=[];return Object.keys(e).forEach(s=>{t.includes(s)?r[s]=e[s]:o.push(s)}),{allowed:r,notAllowed:o}},tt=S(p),rt=l((e,t,r)=>a(void 0,null,function*(){if(e.body.password||e.body.passwordConfirm)return r(new i("This route is not for password updates.Please use /updateMyPassword",400));let o=Cr(e.body,"name","email");e.file&&(o.allowed.photo=e.file.filename);let{allowed:s,notAllowed:n}=o;Object.keys(s).length===0&&n.length>0&&t.status(400).json({status:"fail",message:`Not allowed fields found: ${n.join(", ")}`});let d=yield p.findByIdAndUpdate(e.user.id,s,{new:!0,runValidators:!0});n.length>0?t.status(400).json({status:"partial",message:`Unable to update these fields: ${n.join(", ")}`,data:{user:d}}):t.status(200).json({status:"success",data:{user:d}})})),ot=(e,t,r)=>{e.params.id=e.user.id,r()},st=l((e,t,r)=>a(void 0,null,function*(){yield p.findByIdAndUpdate(e.user.id,{active:!1}),t.status(204).json({status:"success",data:null})})),nt=(e,t)=>{t.status(500).json({status:"error",message:"This route is not not defined. Please use /signup instead "})},ue=k(p),at=A(p),it=E(p);var y=ut.default.Router();y.post("/signup",De);y.get("/verifyEmail/:token",_e);y.post("/login",Ne);y.get("/logout",Ue);y.post("/forgotPassword",qe);y.patch("/resetPassword/:token",He);y.use(f);y.get("/me",ot,ue);y.patch("/updateMyPassword",Me);y.patch("/updateMe",Ze,et,rt);y.delete("/deleteMe",st);y.use(w("admin"));y.route("/").get(tt).post(nt);y.route("/:id").get(ue).patch(at).delete(it);var lt=y;var Ct=u(require("express"));var q=u(require("mongoose")),dt=new q.default.Schema({tour:{type:q.default.Schema.Types.ObjectId,ref:"Tour",required:[!0,"Booking must belong to a tour"]},user:{type:q.default.Schema.Types.ObjectId,ref:"User",required:[!0,"Booking must belong to a user"]},price:{type:Number,required:[!0,"Booking must have a price"]},createdAt:{type:Date,default:Date.now()},paid:{type:Boolean,default:!0}});dt.pre(/^find/,function(e){this.populate("user").populate({path:"tour",select:"name"}),e()});var br=q.default.model("Booking",dt),b=br;var ct=(e,t,r)=>{let{alert:o}=e.query;o==="booking"&&(t.locals.alert="Your booking was successful! Please check your email for a confirmation. If your booking does not show up here immediately, please come back later."),r()},pt=l((e,t,r)=>a(void 0,null,function*(){let o=yield m.find();t.status(200).render("overview",{title:"All tours",tours:o})})),mt=l((e,t,r)=>a(void 0,null,function*(){let o=yield m.findOne({slug:e.params.slug}).populate({path:"reviews",select:"review rating user"});if(!o)return r(new i("There is no tour with that name.",404));t.status(200).render("tour",{title:`${o.name} tour`,tour:o})})),gt=(e,t)=>{t.status(200).render("login",{title:"Log into your account"})},ft=(e,t)=>{t.status(200).render("signup",{title:"Signup"})},ht=(e,t)=>{t.status(200).render("account",{title:"Your account"})},yt=(e,t)=>{t.status(200).render("verifiedEmail",{title:"Email Verification"})},wt=l((e,t,r)=>a(void 0,null,function*(){let s=(yield b.find({user:e.user.id})).map(d=>d.tour),n=yield m.find({_id:{$in:s}});t.status(200).render("overview",{title:"My Tours",tours:n})})),vt=l((e,t,r)=>a(void 0,null,function*(){let o=yield T.find({user:e.user.id});t.status(200).render("reviews",{title:"My Reviews",reviews:o})})),Rt=(e,t)=>{t.status(200).render("forgotPassword",{title:"Forgot Password"})},Tt=(e,t)=>{let{token:r}=e.params;t.locals.token=r,t.status(200).render("resetPassword",{title:"Reset Password"})};var v=Ct.default.Router();v.use(ct);v.get("/",z,pt);v.get("/tour/:slug",z,mt);v.get("/login",z,gt);v.get("/signup",ft);v.get("/me",f,ht);v.get("/my-tours",f,wt);v.get("/my-reviews",f,vt);v.get("/forgot-password",Rt);v.get("/email-confirm/:token",Be,yt);v.get("/reset-password/:token",Tt);var xt=v;var jt=u(require("express"));var le=u(require("stripe"));var bt=l((e,t,r)=>a(void 0,null,function*(){let o=new le.default(process.env.STRIPE_SECRET_KEY,{apiVersion:"2022-11-15"}),s=yield m.findById(e.params.tourId);if(s){let n=yield o.checkout.sessions.create({line_items:[{quantity:1,price_data:{currency:"aud",unit_amount:s.price*100,product_data:{name:`${s.name} Tour`,description:s.summary,images:[`${e.protocol}://${e.get("host")}/img/tours/${s.imageCover}`]}}}],mode:"payment",success_url:`${e.protocol}://${e.get("host")}/my-tours?alert=booking`,cancel_url:`${e.protocol}://${e.get("host")}/tour/${s.slug}`,client_reference_id:e.params.tourId,customer_email:e.user.email});t.status(200).json({status:"success",session:n})}})),kr=e=>a(void 0,null,function*(){var s;let t=e.client_reference_id,r=(s=yield p.findOne({email:e.customer_email}))==null?void 0:s._id,o=e.amount_total/100;yield b.create({tour:t,user:r,price:o})}),St=(e,t,r)=>{let o=new le.default(process.env.STRIPE_SECRET_KEY,{apiVersion:"2022-11-15"}),s=e.headers["stripe-signature"],n;try{n=o.webhooks.constructEvent(e.body,s,process.env.STRIPE_WEBHOOK_SECRET)}catch(d){return t.status(400).send(`Webhook error: ${d.message}`)}n.type==="checkout.session.completed"&&kr(n.data.object),t.status(200).json({received:!0})},kt=O(b),Et=S(b),At=k(b),Pt=A(b),Ot=E(b);var j=jt.default.Router();j.use(f);j.get("/checkout-session/:tourId",f,bt);j.use(w("lead-guide","admin"));j.route("/").get(Et).post(kt);j.route("/:id").get(At).patch(Pt).delete(Ot);var It=j;var c=(0,I.default)();c.enable("trust proxy");c.set("view engine","pug");c.set("views",de.default.join(__dirname,"views"));c.use((0,ce.default)());c.options("*",(0,ce.default)());c.use(I.default.static(de.default.join(__dirname,"public")));c.use(Nt.default.crossOriginResourcePolicy({policy:"same-origin"}));process.env.NODE_ENV==="development"&&c.use((0,Dt.default)("dev"));var Er=(0,_t.default)({max:100,windowMs:60*60*1e3,message:"Too many request from this IP,please try again in an hour"});c.use("/api",Er);c.post("/webhook-checkout",I.default.raw({type:"application/json"}),St);c.use(I.default.json({limit:"10kb"}));c.use((0,Mt.default)());c.use(I.default.urlencoded({extended:!0,limit:"10kb"}));c.use((0,Ut.default)());c.use((0,qt.default)());c.use((0,Ht.default)({whitelist:["duration","ratingsQuantity","ratingsAverage","maxGroupSize","difficulty","price"]}));c.use((0,Bt.default)());c.use((e,t,r)=>{e.RequestTime=new Date().toISOString(),r()});c.use("/",xt);c.use("/api/v1/tours",Qe);c.use("/api/v1/users",lt);c.use("/api/v1/reviews",G);c.use("/api/v1/bookings",It);c.all("*",(e,t,r)=>{r(new i(`Can't find ${e.originalUrl} on this server!`,404))});c.use(ye);var Ft=c;process.on("uncaughtException",e=>{console.log(e.name,e.message),console.log("UNCAUGHT EXCEPTION! Shutting down..."),process.exit(1)});Wt.default.config({path:"./.env"});var Vt="";process.env.DATABASE&&process.env.DATABASE_PASSWORD&&(Vt=process.env.DATABASE.replace("<PASSWORD>",process.env.DATABASE_PASSWORD));pe.default.set("strictQuery",!0);pe.default.connect(Vt).then(()=>{console.log("DB connection successful")});var Lt=process.env.PORT||3e3,Jt=Ft.listen(Lt,()=>console.log(`App running on ${Lt}...`));process.on("unhandledRejection",e=>{console.log(e.name,e.message),console.log("UNHANDLED REJECTION! Shutting down..."),Jt.close(()=>process.exit(1))});process.on("SIGTERM",()=>{console.log("SIGTERM RECEIVED. Shutting down gracefully"),Jt.close(()=>console.log("Process terminated"))});
